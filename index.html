<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ุฃุฎุชุจุงุฑ ูุงุฏุฉ ููุฒูุงุก 3-3</title>

  <!-- ุฑุจุท ููู CSS (ููุง ูู ุงูุฃุตู) -->
  <link rel="stylesheet" href="style.css">

  <!-- ููุชุจุฉ MathJax ูุนุฑุถ ุงููุนุงุฏูุงุช (ููุง ูู ุงูุฃุตู) -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [["$","$"], ["\\(","\\)"]],
        displayMath: [["$$","$$"], ["\\[","\\]"]]
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <!-- ููุชุจุฉ html2pdf (ููุง ูู ุงูุฃุตู) -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- ุชุญูู ุจุณูุท ูู ุงูููุฏ ูุงูุฅูููู ูู ุงูู Query String (ููุฏ ุงูุตูุญุฉ ุงูุฃุตููุฉุ ูููู ููุนููู ุฃุฏูุงู) -->
  <script>
    /*
    // ุงุฌูุจ ุงูููุฏ ูุงูุฅูููู ูู ุฑุงุจุท ุงูุตูุญุฉ
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const email = params.get("email");

    // ุฅู ูู ูุชููุฑ ุงูููุฏ ูุงูุฅููููุ ุฅุนุงุฏุฉ ุชูุฌูู ูู check.html
    if(!code || !email) {
      alert("๐ซ ูุง ููููู ุงูุฏุฎูู ุจุฏูู ููุฏ ูุจุฑูุฏ ุฅููุชุฑููู");
      window.location.href = "check.html";
    } else {
      console.log("ููุฏ ุงูุฏุฎูู =", code);
      console.log("ุงูุฅูููู =", email);
      // ุจุฅููุงูู ููุง ุฅุถุงูุฉ ุชุญูู ุฅุถุงูู
    }
    */
  </script>

  <!-- 1) ุจูู ุงูุฃุณุฆูุฉ -->
  <script src="questionsDatabase.js"></script>

  <!-- 2) ููุฏ ุงูููุทู ุจุนุฏู -->
  <script src="script.js"></script>

  <!--
    ููููู ููุง ุฃู ูู ุขุฎุฑ ููู style.css ุฅุถุงูุฉ ุงูุชูุณููุงุช ุงูุฅุถุงููุฉ
    ุงูุฎุงุตุฉ ุจูุณู ุงูุชุญูู + ุงูู Media Query ููุชูุงูู ูุน ุงูุฌูุงู
  -->
  <style>
    /*******************************
     * ูุณู ุงูุชุญูู (ูุฏูุฌ ูู check.html)
     *******************************/
    #verifySection {
      text-align: center;
      margin-top: 20px;
    }
    .verify-container {
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      max-width: 400px;
      margin: 30px auto 0 auto;
      padding: 20px;
      text-align: center;
    }
    .verify-container input, .verify-container button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .verify-container button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .verify-container button:hover {
      background-color: #0056b3;
    }
    .verify-container .red-note {
      color: red;
      margin-top: 10px;
      font-size: 14px;
    }
    .verify-container .code-box {
      margin-top: 20px;
      font-size: 18px;
      color: green;
      word-wrap: break-word;
    }

    /**********************************************
     * ุฃู ุชูุณููุงุช ูู style.css (ุงูุฎุงุตุฉ ุจุงูุงูุฏูุณ)
     * ุณุชุจูู ููุง ูู. ูู ูุงูุช ูู ููู ุฎุงุฑุฌูุ
     * ุชุฃูุฏ ุฃููุง ูุฑุจูุทุฉ ุจููุณ ุงูุดูู.
     **********************************************/

    /***********************************************************
     *  ูุซุงู ุฅุถุงูุฉ Media Query ูุชุตููู ุงูุฌูุงู
     *  (ููููู ุถุจุท ุงูุญุฌู max-width ููุง ุชุฑูุฏ)
     ***********************************************************/
      </style>

</head>

<body>

  <!-- ====================
       ูุณู ุงูุชุญูู ุงููุฏูุฌ
       ==================== -->
  <div id="verifySection">
    <div class="verify-container">
      <h2>ุฃุฏุฎู ุฑูู ุงูุทูุจ ูุงูุจุฑูุฏ</h2>

      <div id="form">
        <input type="text" id="orderId" placeholder="ุฑูู ุงูุทูุจ" />
        <input type="email" id="email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู" />
        <button onclick="checkCode()">ุชุญูู</button>

        <button onclick="goToStore()">ุฒูุงุฑุฉ ุงููุชุฌุฑ ููุดุฑุงุก</button>

        <div class="red-note">
          ุฑูู ุงูุทูุจ ูุงูุงูููู ูุงูุฑูุงุจุท ุงูุฎุงุตุฉ ุงููุฑุชุจุทุฉ ุจุจูู ุงูุงุณุฆูุฉ ูุณุคููุชู ุงูุดุฎุตูุฉ.
          <br>ุฃู ุฅุณุงุกุฉ ุงุณุชุฎุฏุงู ุณูุชู ุชุนุทูู ุนุถููุชู ููุฑูุง.
        </div>
      </div>

      <div id="result" class="code-box"></div>
    </div>
  </div>
  <!-- ููุงูุฉ ูุณู ุงูุชุญูู -->

  <!-- =========================
       ูู ูุญุชูู index ุงูุฃุตูู
       ูุฎูู ูุคูุชูุง
       ========================= -->
  <div id="mainContent" style="display: none;">
    <!-- ุงูุตูุญุฉ ุงูุฃููู (ุจูุงูุงุช ุฃุณุงุณูุฉ) -->
    <div id="page1" class="container">
      <h3>ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ (ุฌููุนูุง ุญููู ุฅูุฒุงููุฉ)</h3>
      
      <!-- ุงุณู ุงููุนูู -->
      <label>ุงุณู ุงููุนูู:</label>
      <input type="text" id="teacherName" required placeholder="ูุซุงู: ุฃ. ููุงู ุงูุทูููุนู" oninput="saveFormState()">

      <!-- ุงูุนุงู ุงูุฏุฑุงุณู -->
      <label>ุงูุนุงู ุงูุฏุฑุงุณู:</label>
      <input type="text" id="academicYear" required placeholder="ูุซุงู: 1444" oninput="updateAcademicYear(); saveFormState();">

      <!-- ุฅุฏุงุฑุฉ ุงูุชุนููู -->
      <label>ุฅุฏุงุฑุฉ ุงูุชุนููู :</label>
      <input type="text" id="educationDepartment" required placeholder="ูุซุงู: ุฌุฏุฉ" oninput="updateEducationDepartment(); saveFormState();">

      <!-- ููุน ุงูุงุฎุชุจุงุฑ -->
      <label>ููุน ุงูุงุฎุชุจุงุฑ :</label>
      <select id="examType" required onchange="updateExamType(); saveFormState();">
        <option value="">ุงุฎุชุฑ ููุน ุงูุงุฎุชุจุงุฑ</option>
        <option value="ุงุฎุชุจุงุฑ ุงููุชุฑุฉ ุงูุงููู">ุงุฎุชุจุงุฑ ุงููุชุฑุฉ ุงูุงููู</option>
        <option value="ุงุฎุชุจุงุฑ ููุงุฆู">ุงุฎุชุจุงุฑ ููุงุฆู</option>
        <option value="ุฃุฎุชุจุงุฑ ูุตูุฑ">ุฃุฎุชุจุงุฑ ูุตูุฑ</option>
        <option value="ูุงุฌุจ">ูุงุฌุจ</option>
      </select>

      <!-- ุงูุฏุฑุฌุฉ ุงููููุฉ -->
      <label>ุงูุฏุฑุฌุฉ ุงููููุฉ :</label>
      <input type="number" id="manualTotalScore" required min="0" value="0" oninput="updateManualTotalScore(); saveFormState();">

      <!-- ุงุณู ุงููุฏุฑุณุฉ -->
      <label>ุงุณู ุงููุฏุฑุณุฉ :</label>
      <input type="text" id="schoolName" required placeholder="ูุซุงู: ุซุงูููุฉ ุงูููู ููุฏ" oninput="saveFormState()">

      <!-- ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ูุงุฎุชูุงุฑ ุจููู/ุจูุงุช -->
      <label for="genderSelect">ุงุฎุชุฑ ุงูููุน:</label>
      <select id="genderSelect" onchange="toggleGenderMode()">
        <option value="boys" selected>ุจููู</option>
        <option value="girls">ุจูุงุช</option>
      </select>

      <button onclick="validateAndGoNext()">ุงูุชุงูู</button>
    </div>

    <!-- ุงูุตูุญุฉ ุงูุซุงููุฉ (Page 2) -->
    <div id="page2" class="container" style="display: none;">
      <!-- ุงุฎุชูุงุฑ ุงููุตู/ุงููุญุฏุฉ -->
      <label>ุงุฎุชุฑ ุงูููุถูุน (ุงููุตู):</label>
      <select id="subject" onchange="showSubtopics()">
        <option value="">ุงุฎุชุฑ ุงูููุถูุน</option>
        <option value="electromagnetic_induction">ุงููุตู ุงูุงูู ุงูุญุซ ุงูููุฑููุบูุงุทูุณู</option>
        <option value="electromagnetism">ุงููุตู ุงูุซุงูู ุงูููุฑููุบูุงุทูุณูุฉ</option>
        <option value="quantum_theory">ุงููุตู ุงูุซุงูุซ ูุธุฑูุฉ ุงููู</option>
        <option value="atomic_physics">ุงููุตู ุงูุฑุงุจุน ุงูุฐุฑุฉ</option>
        <option value="solid_state_electronics">ุงููุตู ุงูุฎุงูุณ ุงููุชุฑูููุงุช ุงูุญุงูุฉ ุงูุตูุจุฉ</option>
        <option value="nuclear_physics">ุงููุตู ุงูุณุงุฏุณ ุงูููุฒูุงุก ุงูููููุฉ</option>
      </select>

      <label id="subtopicLabel" style="display:none;">ุงุฎุชุฑ ุงููุณู ุงููุฑุนู:</label>
      <select id="subtopicSelect" style="display:none;" onchange="showQuestionsForSubtopic()">
        <option value="">ุงุฎุชุฑ ุงููุณู ุงููุฑุนู</option>
      </select>

      <!-- ูุณู ุนุฑุถ ูุงุฆูุฉ ุงูุฃุณุฆูุฉ -->
      <div id="questionList" style="
        display:none; 
        border:1px solid #ccc; 
        padding:10px; 
        min-height:120px; 
        max-height:400px; 
        overflow:auto; 
        width:100%;
      ">
        <p style="font-size:14px; color:#999; text-align:center;">ุงุฎุชุฑ ุณุคุงู ูุฅุถุงูุชู</p>
      </div>

      <hr style="margin: 20px 0;">

      <!-- ุงูุจุญุซ ูู ุฌููุน ุงูุฃุณุฆูุฉ -->
      <h4>ุงูุจุญุซ ูู ุฌููุน ุงูุฃุณุฆูุฉ (ูู ูุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช)</h4>
      <input type="text" id="searchQuestionsInput" placeholder="ุงูุชุจ ูููุงุช ุงูุจุญุซ..." oninput="searchAllQuestions()">
      <div id="searchResults" style="border:1px solid #ccc; padding:5px; min-height:120px; max-height:200px; overflow:auto;">
        <p style="font-size:14px; color:#999; text-align:center;">ุงูุชุจ ูููุงุช ุงูุจุญุซ ุฃุนูุงู</p>
      </div>

      <hr style="margin: 20px 0;">

      <!-- ุฅุถุงูุฉ ุณุคุงู ูุฎุตุต -->
      <h4>ุฅุถุงูุฉ ุณุคุงู ูุฎุตุต</h4>
      <select id="customQuestionType" onchange="handleCustomTypeChange()">
        <option value="">ุงุฎุชุฑ ููุน ุงูุณุคุงู</option>
        <option value="mcq">ุณุคุงู ุงุฎุชูุงุฑ ูุชุนุฏุฏ</option>
        <option value="tf">ุณุคุงู ุตุญ ูุฎุทุฃ</option>
        <option value="essay">ุณุคุงู ููุงูู/ูุณุฃูุฉ</option>
      </select>

      <div id="customFieldsContainer">
        <!-- MCQ Fields -->
        <div id="mcqFields" style="display:none; margin-top:10px;">
          <textarea id="mcqQuestionInput" rows="2" placeholder="ูุต ุงูุณุคุงู"></textarea>
          <input type="text" id="mcqOption1" placeholder="ุงูุฎูุงุฑ ุงูุฃูู">
          <input type="text" id="mcqOption2" placeholder="ุงูุฎูุงุฑ ุงูุซุงูู">
          <input type="text" id="mcqOption3" placeholder="ุงูุฎูุงุฑ ุงูุซุงูุซ">
          <input type="text" id="mcqOption4" placeholder="ุงูุฎูุงุฑ ุงูุฑุงุจุน">
        </div>

        <!-- TF Fields -->
        <div id="tfFields" style="display:none; margin-top:10px;">
          <textarea id="tfQuestionInput" rows="2" placeholder="ูุต ุงูุณุคุงู"></textarea>
        </div>

        <!-- Essay Fields -->
        <div id="essayFields" style="display:none; margin-top:10px;">
          <textarea id="essayQuestionInput" rows="4" placeholder="ูุต ุงูุณุคุงู ุงูููุงูู ุฃู ุงููุณุฃูุฉ"></textarea>
          <input type="file" id="essayImageInput" accept="image/*">
        </div>
      </div>

      <button onclick="addCustomQuestion()" style="display:none;" id="addCustomBtn">ุฃุถู ุงูุณุคุงู</button>

      <hr style="margin: 20px 0;">

      <!-- ุฒุฑ ุทุจุงุนุฉ -->
      <button onclick="printExam()">ูุนุงููุฉ ุงูุดูู ุงูููุงุฆู ููุฑูุฉ ุงูุงุฎุชุจุงุฑ - ุญูุธ PDF - ุทุจุงุนุฉ</button>

      <!-- ุฒุฑ ุงูุฑุฌูุน ููุตูุญุฉ ุงูุฃููู -->
      <button onclick="goBackToPage1()">ุฑุฌูุน</button>
    </div>

    <!-- ููุทูุฉ ุงููุนุงููุฉ ุงูููุงุฆูุฉ ููุงุฎุชุจุงุฑ -->
    <div id="examPreview">
      <img id="examLogo" class="exam-logo" src="https://i.imgur.com/gcGPjyB.png" alt="ุดุนุงุฑ ูุฒุงุฑุฉ ุงูุชุนููู">
      <div class="header">
        <p class="test-time" id="testTime"></p>
        <p>ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ</p>
        <p>ูุฒุงุฑุฉ ุงูุชุนููู</p>
        <p id="educationDepartmentHeader">ุฅุฏุงุฑุฉ ุงูุชุนููู ุจููุทูุฉ</p>
        <p id="schoolHeader">ุงุณู ุงููุฏุฑุณุฉ</p>
        <p class="student-name" id="studentHeader">ุงุณู ุงูุทุงูุจ: ____________________</p>
        <p class="seat-number" id="seatNumber" style="position: absolute; top: 85px; left: 10px;">ุฑูู ุงูุฌููุณ: ____________________</p>
        <p class="teacher-name" id="teacherHeader">ูุนูู ุงููุงุฏุฉ: </p>
      </div>

      <p style="font-size: 18px; font-weight: bold;" id="academicYearDisplay">
        - ููุฒูุงุก 1 ุฃูู ุซุงููู ุงูุนุงู ุงูุฏุฑุงุณู ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู
      </p>
      <p id="examDetails"></p>
      <hr style="margin: 20px 0; border: 1px solid #000;">

      <div class="grade-container" style="display:none;">
        <div class="grade-label">ุงูุฏุฑุฌุฉ ุงููููุฉ</div>
        <div class="split-box">
          <div class="upper"></div>
          <div class="lower" id="totalExamScore">0</div>
        </div>
      </div>

      <div id="questionsCount">
        <p>ุนุฏุฏ ุฃุณุฆูุฉ ุงูุงุฎุชูุงุฑ ุงููุชุนุฏุฏ: <span id="mcqCount">0</span></p>
        <p>ุนุฏุฏ ุฃุณุฆูุฉ ุงูุตุญ ูุงูุฎุทุฃ: <span id="tfCount">0</span></p>
        <p>ุนุฏุฏ ุงูุฃุณุฆูุฉ ุงูููุงููุฉ: <span id="essayCount">0</span></p>
        <p>ุงูุนุฏุฏ ุงูููู ููุฃุณุฆูุฉ: <span id="totalQuestionsCount">0</span></p>
      </div>

      <div class="mcq-section" style="display:none;">
        <h3></h3>
        <ol id="mcqList" style="margin: 0; padding: 0 20px;"></ol>
      </div>
      <div class="tf-section" style="display:none;">
        <h3></h3>
        <ol id="tfList"></ol>
      </div>
      <div class="essay-section" style="display:none;">
        <h3></h3>
        <ol id="essayList"></ol>
      </div>
    </div>
    <!-- ููุงูุฉ ุงููุญุชูู ุงูุฃุตูู -->
  </div> <!-- ููุงูุฉ mainContent -->

  <script>
    /* ===========================
       ุฏูุงู ูุณู ุงูุชุญูู (ูุฃุฎูุฐุฉ ูู check.html)
       =========================== */

    // ุฑุงุจุท ุงูุฏุงูุฉ ูุฌูุจ ุจูุงูุงุช ุงูุทูุจุงุช
    const sheetURL = "/.netlify/functions/sheetdata";

    // ุญูุธ ูุฅุนุงุฏุฉ ุชุนุจุฆุฉ ุงูุญููู ูู LocalStorage:
    window.addEventListener('DOMContentLoaded', () => {
      const savedOrderId = localStorage.getItem('savedOrderId');
      const savedEmail = localStorage.getItem('savedEmail');
      if (savedOrderId) {
        document.getElementById('orderId').value = savedOrderId;
      }
      if (savedEmail) {
        document.getElementById('email').value = savedEmail;
      }
    });

    async function checkCode(orderIdParam = '', emailParam = '') {
      const orderId = orderIdParam || document.getElementById('orderId').value.trim();
      const email = emailParam || document.getElementById('email').value.trim().toLowerCase();
      const resultBox = document.getElementById('result');

      if (!orderId || !email) {
        resultBox.textContent = 'ุงูุฑุฌุงุก ุชุนุจุฆุฉ ุงูุจูุงูุงุช ุฃููุงู';
        return;
      }

      // ูุญูุธ ุขุฎุฑ ูุฏุฎูุงุช ูู LocalStorage
      localStorage.setItem('savedOrderId', orderId);
      localStorage.setItem('savedEmail', email);

      resultBox.textContent = 'ุฌุงุฑู ุงูุชุญูู...';

      try {
        // ุฌูุจ ุจูุงูุงุช ุงูุทูุจุงุช
        const response = await fetch(sheetURL);
        if (!response.ok) {
          throw new Error("ูุดู ูู ุงูุงุชุตุงู ุจุงูุฏุงูุฉ");
        }

        const data = await response.json();
        // ุงุจุญุซ ุนู ุณุฌู ูุทุงุจู order_id ูุงูุจุฑูุฏ
        const match = data.find(entry =>
          entry.order_id?.trim() === orderId &&
          entry.email?.trim().toLowerCase() === email
        );

        if (match) {
          alert("โ ุชู ุงูุนุซูุฑ ุนูู ุงูุทูุจุ ุณูุชู ุนุฑุถ ุงูุตูุญุฉ ุงูุขู");
          // ุฅุฎูุงุก ูุณู ุงูุชุญูู
          document.getElementById('verifySection').style.display = 'none';
          // ุฅุธูุงุฑ ุงููุญุชูู ุงูุฃุตูู
          document.getElementById('mainContent').style.display = 'block';

          resultBox.textContent = "ุชู ุงูุชุญูู ุจูุฌุงุญ!";
        } else {
          alert("โ ุงูุทูุจ ุบูุฑ ููุฌูุฏ ุฃู ุงูุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ");
          resultBox.textContent = 'โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุทูุจ. ุชุฃูุฏ ูู ุงูุจูุงูุงุช.';
        }
      } catch (err) {
        alert("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุฃู ุฃุซูุงุก ุฌูุจ ุงูุจูุงูุงุช");
        resultBox.textContent = 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญูู.';
        console.error(err);
      }
    }

    function goToStore() {
      const storeUrl = "https://myexams.myshopify.com/products/ุจุงูุฉ-ูุงุฏุฉ-ูุงุญุฏุฉ-15ุฑูุงู";
      const chromeSchemeUrl = "googlechrome://myexams.myshopify.com/products/ุจุงูุฉ-ูุงุฏุฉ-ูุงุญุฏุฉ-15ุฑูุงู";

      window.location.href = chromeSchemeUrl;
      setTimeout(() => {
        window.location.href = storeUrl;
      }, 2000);
    }
  </script>

</body>
</html>
